<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Installation System</title>
    <link rel="stylesheet" href="style.css">
    <script src="libs/jquery-3.7.1.min.js"></script>
    <script src="settings.js"></script>
</head>
<body>

    <div class="main-container">
        <!-- Left Side: Preview -->
        <div class="preview-area">
            <div class="canvas-wrapper" id="canvas-wrapper">
                <iframe src="../artwork_geometric_flowers/index.html" title="Artwork Preview" id="artwork-frame"></iframe>
            </div>
            <!-- Message Toast -->
            <div id="message-toast" class="toast-container"></div>
        </div>

        <!-- Right Side: Controls -->
        <div class="control-panel">
            <div class="panel-top">
                <h1 class="artwork-title">Geometric Flowers</h1>
                
                <div class="controls-form">
                    <div class="control-group">
                        <label for="param-a">Parameter A <span>50</span></label>
                        <input type="range" id="param-a" name="a" min="0" max="100" value="50">
                    </div>

                    <div class="control-group">
                        <label for="param-b">Parameter B <span>50</span></label>
                        <input type="range" id="param-b" name="b" min="0" max="100" value="50">
                    </div>

                    <div class="control-group">
                        <label for="param-c">Parameter C <span>50</span></label>
                        <input type="range" id="param-c" name="c" min="0" max="100" value="50">
                    </div>

                    <div class="control-group">
                        <label for="param-d">Parameter D <span>50</span></label>
                        <input type="range" id="param-d" name="d" min="0" max="100" value="50">
                    </div>
                </div>
            </div>

            <div class="panel-bottom">
                <button class="btn-print" id="save-btn" style="margin-bottom: 1rem;">Save Image</button>
                <button class="btn-print" id="print-pdf-btn" style="margin-bottom: 1rem;">Print (pdf-to-printer)</button>
                <button class="btn-print" id="print-ipp-btn" style="margin-bottom: 1rem;">Print (IPP)</button>
                <button class="btn-print" id="print-ipp-pdf-btn" style="margin-bottom: 1rem;">Print (IPP & PDF)</button>
                <button class="btn-print" id="print-web">Print (Web)</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize canvas size from settings
        function initCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            const frame = document.getElementById('artwork-frame');
            
            if (typeof SYSTEM_SETTINGS !== 'undefined') {
                const aspectRatio = SYSTEM_SETTINGS.width + ' / ' + SYSTEM_SETTINGS.height;
                wrapper.style.setProperty('--aspect-ratio', aspectRatio);

                // Apply padding to the preview area (controls how large the canvas is relative to the screen)
                if (SYSTEM_SETTINGS.previewPadding !== undefined) {
                     const previewArea = document.querySelector('.preview-area');
                     previewArea.style.padding = SYSTEM_SETTINGS.previewPadding + 'px';
                }
                
                // Update the iframe source to include dimensions in query params
                // This allows the p5 sketch to read them in setup()
                const currentSrc = frame.getAttribute('src').split('?')[0]; // Remove old params if any
                const newSrc = `${currentSrc}?w=${SYSTEM_SETTINGS.width}&h=${SYSTEM_SETTINGS.height}`;
                frame.setAttribute('src', newSrc);
            }
        }
        
        // Show Toast Message Function
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('message-toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            // Clear any existing timeout to prevent overlapping
            if (toast.timeoutId) {
                clearTimeout(toast.timeoutId);
            }
            
            // Hide after duration
            toast.timeoutId = setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Call initialization
        initCanvas();

        // Simple script to update label values when sliders move
        const inputs = document.querySelectorAll('input[type="range"]');
        inputs.forEach(input => {
            input.addEventListener('input', (e) => {
                // Find the span inside the corresponding label
                const label = e.target.previousElementSibling;
                const span = label.querySelector('span');
                if (span) {
                    span.textContent = e.target.value;
                }
            });
        });

        // Helper function to send image to backend
        function saveImageToServer() {
            return new Promise((resolve, reject) => {
                const artworkFrame = document.getElementById('artwork-frame');
                
                try {
                    const canvas = artworkFrame.contentWindow.document.querySelector('canvas');
                    
                    if (!canvas) {
                        return reject(new Error('Canvas not found in iframe'));
                    }

                    const dataUrl = canvas.toDataURL('image/png');
                    
                    fetch('/api/save-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ image: dataUrl })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            resolve(data);
                        } else {
                            reject(new Error(data.message));
                        }
                    })
                    .catch(error => reject(error));
                    
                } catch (e) {
                    reject(new Error('Cannot access artwork content.'));
                }
            });
        }

        // Save Image button logic
        $('#save-btn').on('click', async () => {
            console.log("Save button clicked");
            
            let resultData = await saveImageToServer();

            console.log(resultData);
            showToast("Image saved: " + resultData.filename, 3000);
        });

        // Print (pdf-to-printer) button logic
        $('#print-pdf-btn').on('click', async () => {
            console.log("Print (pdf-to-printer) button clicked");
            const printApiUrl = '/api/print-pdf';

            await saveAndPrint(printApiUrl);
        });

        // Print (IPP) button logic
        $('#print-ipp-btn').on('click', async () => {
            console.log("Print (IPP) button clicked");
            const printApiUrl = '/api/print-ipp';
            await saveAndPrint(printApiUrl);
        });

        // Print (IPP & PDF) button logic
        $('#print-ipp-pdf-btn').on('click', async () => {
            console.log("Print (IPP & PDF) button clicked");
            const printApiUrl = '/api/print-ipp-pdf';
            await saveAndPrint(printApiUrl);
        });

        $('#print-web').on('click', async () => {
            console.log("Print (Web) button clicked");
            showToast("Preparing web print...", 2000);
            
            try {
                // save image first
                let resultData = await saveImageToServer();
                console.log("Image saved:", resultData.filename);
                
                // Construct absolute path to the image on the server
                const imageUrl = '/_iteration_output/' + resultData.filename;
                
                // Open a new window to print the specific image
                const printWindow = window.open('', '_blank');
                if (printWindow) {
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>Print Artwork</title>
                                <style>
                                    @page { size: auto; margin: 0mm; }
                                    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
                                    img { max-width: 100%; max-height: 100%; object-fit: contain; }
                                </style>
                            </head>
                            <body>
                                <img src="${imageUrl}" onload="setTimeout(() => { window.print(); window.close(); }, 500);">
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.focus();
                } else {
                    showToast("Popup blocked! Please allow popups to print.", 5000);
                }
            } catch (e) {
                console.error("Web Print Error:", e);
                showToast("Error: " + e.message, 5000);
            }
        });
        
        // Helper function to save image first, then call print API
        async function saveAndPrint(printApiUrl) {
            console.log("Starting print process...");
            
            try {
                // 1. Save Image first using the helper function
                const saveData = await saveImageToServer();
                
                console.log("Image saved:", saveData.filename);

                await sleep(1000); // Small delay for better UX
                
                // 2. Call Print API with filename
                const printResponse = await fetch(printApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: saveData.filename })
                });
                
                const printData = await printResponse.json();
                
                if (printData.success) {
                    showToast("Success: " + printData.message, 5000);
                } else {
                    showToast("Print Error: " + printData.message, 5000);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error: ' + error.message, 5000);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>

